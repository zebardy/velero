---
kind: pipeline
type: kubernetes
name: default

platform:
  os: linux
  arch: aarch64

trigger:
  branches:
    - master
  event:
    - push

steps:
  - name: docker
    image: plugins/docker
    commands:
    - echo "testing scripts"
    - apk add make git grep wget
    - ls -lrt /usr/libexec/ | grep docker || true
    - ls -lrt /usr/lib/ | grep docker || true
    - ls -lrt /usr/local/libexec/ | grep docker || true
    - ls -lrt /usr/local/lib/ | grep docker || true
    - ls -lrta $HOME/ | grep docker || true
    - which docker
    - docker help
    - mkdir -p /usr/local/libexec/docker/cli-plugins/
    - wget https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-arm64
    - mv ./buildx-v0.5.1.linux-arm64 /usr/local/libexec/docker/cli-plugins/docker-buildx
    - docker help
    - make all-containers
    - echo "success"
    settings:
      username:
        from_secret: docker_username
      password:
        from_secret: docker_password
      repo: zebardy/velero
